<html>
<title>Learning from Machines</title>
<link rel=stylesheet href=base.less>
<link rel=stylesheet href=title.less>
<link rel=stylesheet href=hallucinations.less>
<link rel=stylesheet href=inside.less>
<link rel=stylesheet href=dreams.less>

<script src=main.js></script>
<script src=create.js></script>
<script>
  const {min, max} = Math
</script>

<body>
  <div id=titleCard class=vbox>
    <type-writer id=titleWriter></type-writer>
  </div>
  <build-note id=titleBlank            data-text=""></build-note>
  <build-note id=titleLfm              data-text="learning from machines"></build-note>
  <build-note id=titleLfmErased        data-text=""></build-note>
  <build-note id=title1                data-text="1. "></build-note>
  <build-note id=title1Hallucinations  data-text="1. hallucinations"></build-note>
  <script>
    When(buildInRange(titleBlank, title1Hallucinations))
      .withName('titleWriter')
      .changed((_, current, prev) => {
        titleWriter.text = current.dataset.text
      })
  </script>

  <!-- 1. hallucinations -->
  <div id=hallucinations class=seed>
    <!-- 1a. the inception neural network -->
    <img id=inceptionDiagram src=inception-diagram.svg>
    <div id=deepDreamOutputLayer>
      <span class=P>cat</span>
      <span class=P>dog</span>
      <span class=P>person</span>
      <span class=P>banana</span>
      <span class=P>toaster</span>
      </div>
    <video id=skully src=brain-skull-to-vision.m4v is=seekable-video></video>
    <video id=deepDream src=miquel_pn_deep_dream.mp4></video>
    <type-writer id=miquel></type-writer>
    <div id=deepDreamLayers class=stopped>
      <type-writer id=deepDreamCurrentLayer></type-writer>
    </div>        
    <div id=deepDreamInputLayer>
      <canvas id=deepDreamInputPixels></canvas>
    </div>
    <div id=deepDreamInputLayerReceptiveField>
      <div id=deepDreamReceptiveFieldHighlight></div>
    </div>
    <div id=deepDreamConvOutput>
      <script>
        for (let r = 0; r !== 5; ++r) {
          document.write(`<div class="row row-${r}">`)
          for (let c = 0; c !== 5; ++c) {
            document.write(`<div class="cell cell-${r}-${c}"></div>`)
          }
          document.write(`</div>`)
        }
      </script>
    </div>
    <type-writer id=deepDreamConvFilter></type-writer>
    <script>
      const layers = ["Initial input data", "conv1/7x7_s2", "pool1/3x3_s2", "pool1/norm1", "conv2/3x3_reduce", "conv2/3x3", "conv2/norm2", "pool2/3x3_s2", "inception_3a/1x1", "inception_3a/3x3_reduce", "inception_3a/3x3", "inception_3a/5x5_reduce", "inception_3a/5x5", "inception_3a/pool", "inception_3a/pool_proj", "inception_3a/output", "inception_3b/1x1", "inception_3b/3x3_reduce", "inception_3b/3x3", "inception_3b/5x5_reduce", "inception_3b/5x5", "inception_3b/pool", "inception_3b/pool_proj", "inception_3b/output", "pool3/3x3_s2", "inception_4a/1x1", "inception_4a/3x3_reduce", "inception_4a/3x3", "inception_4a/5x5_reduce", "inception_4a/5x5", "inception_4a/pool", "inception_4a/pool_proj", "inception_4a/output", "inception_4b/1x1", "inception_4b/3x3_reduce", "inception_4b/3x3", "inception_4b/5x5_reduce", "inception_4b/5x5", "inception_4b/pool", "inception_4b/pool_proj", "inception_4b/output", "inception_4c/1x1", "inception_4c/3x3_reduce", "inception_4c/3x3", "inception_4c/5x5_reduce", "inception_4c/5x5", "inception_4c/pool", "inception_4c/pool_proj", "inception_4c/output", "inception_4d/1x1", "inception_4d/3x3_reduce", "inception_4d/3x3", "inception_4d/5x5_reduce", "inception_4d/5x5", "inception_4d/pool", "inception_4d/pool_proj", "inception_4d/output", "inception_4e/1x1", "inception_4e/3x3_reduce", "inception_4e/3x3", "inception_4e/5x5_reduce", "inception_4e/5x5", "inception_4e/pool", "inception_4e/pool_proj", "inception_4e/output", "pool4/3x3_s2", "inception_5a/1x1", "inception_5a/3x3_reduce", "inception_5a/3x3", "inception_5a/5x5_reduce", "inception_5a/5x5", "inception_5a/pool", "inception_5a/pool_proj", "inception_5a/output", "inception_5b/1x1", "inception_5b/3x3_reduce", "inception_5b/3x3", "inception_5b/5x5_reduce", "inception_5b/5x5", "inception_5b/pool", "inception_5b/pool_proj", "inception_5b/output", "pool5/7x7_s1"]      
      deepDream.onloadedmetadata = () => {
        const timeAtEachLayer = deepDream.duration / layers.length
        deepDream.timeline = Timeline(
            layers.map((layer, i) => ({
              at: i * timeAtEachLayer, layer
            }))
          )
      }
    </script>
    <script src=inception.js></script>
    <build-note id=dreamFullscreenPaused></build-note>
    <build-note id=dreamFullscreenMiquel></build-note>
    <script>
      When(dreamFullscreenMiquel)
        .start(() => miquel.text = 'Miquel PerellÃ³ Nieto')
        .end(() => miquel.text = '')
    </script>
    <build-note id=dreamFullscreenPlaying></build-note>
    <build-note id=dreamFullscreenShowLayer></build-note>
    <build-note id=inception></build-note>
    <build-note id=inceptionFromInput></build-note>
    <build-note id=inceptionToOutput></build-note>
    <build-note id=inceptionConv></build-note>
    <build-note id=inceptionConvForward></build-note>
    <build-note id=inceptionConvTraining></build-note>
    <build-note id=inceptionIncepting></build-note>
    <build-note id=inceptionPanDiagram></build-note>
    <build-note id=dreamFullscreenPlayingAgain></build-note>
    <script>
      When(dreamFullscreenPaused)
        .start(() => {
          deepDream.currentTime = 0
          deepDream.pause()
        })
      When(buildInRange(dreamFullscreenMiquel, dreamFullscreenPlayingAgain))
        .start(() => {
          deepDream.play()
        })
        .frame(() => {
          if (!deepDream.timeline) return
          deepDreamCurrentLayer.text = deepDream.timeline(deepDream).layer
        })

      inceptionPixelsViz(
        buildInRange(inception, inceptionPanDiagram),
        deepDream,
        deepDreamInputPixels
      )

      When(inceptionConvTraining).frame(every(2[sec]) (() =>
        deepDreamConvFilter.text = randomMatrix(3, 3)
      ))

      const randomRow = w => () => new Array(w).fill(0)
        .map((() => Math.random().toString().substr(0, 3) + ' '))
        .join('') + '\n'
      const randomMatrix = (w, h) =>
        '[\n' + new Array(h).fill(0).map(randomRow(w)).join('') + ']'
    </script>  
    
    <!-- 1b. The human visual system -->
    <build-note id=inside></build-note>
    <build-note id=insideEnterSkully></build-note>
    <build-note id=insideLessCruft></build-note>
    <build-note id=insideRetina></build-note>
    <build-note id=insideRetinaGanglions></build-note>
    <build-note id=insideRetinaEtc></build-note>
    <build-note id=insideRetinaPhotoreceptors></build-note>
    <build-note id=insideRetinaLightGoesIn></build-note>
    <build-note id=insideRetinaSignalComesOut></build-note>
    <build-note id=insideRetinaOpticNerve></build-note>
    <build-note id=insideRetinaReceptiveField></build-note>
    <build-note id=insideRetinaReceptiveFieldFiringWeakly></build-note>
    <build-note id=insideRetinaReceptiveFieldOffCenterFiring></build-note>
    <build-note id=insideRetinaReceptiveFieldOffCenterDead></build-note>
    <build-note id=insideRetinaReceptiveFieldOnCenterFiring></build-note>
    <build-note id=insideThroughTheBrain></build-note>
    <build-note id=insideVisualCortex></build-note>
    <script>
      insideEnterSkully.skully = {time: 0, paused: true}
      insideLessCruft.skully = {time: 14.8, duration: 5, paused: true}
      insideRetina.skully = {time: 20, duration: 20 - 14.8, paused: true}
      insideRetinaGanglions.skully = {time: 29, duration: 29 - 20, paused: true}
      insideRetinaEtc.skully = {time: 31, duration: 31 - 29, paused: true}
      insideRetinaPhotoreceptors.skully = {time: 34, duration: 34 - 31, paused: true}
      insideRetinaLightGoesIn.skully = {time: 34.5, duration: 34.5 - 34, paused: true}
      insideRetinaSignalComesOut.skully = {time: 36.5, duration: 36.5 - 34.5, paused: true}
      insideRetinaOpticNerve.skully = {time: 42, duration: 42 - 36.5, paused: true}
      insideRetinaReceptiveField.skully = {time: 50.84, duration: 50.8 - 42, paused: true}
      insideRetinaReceptiveFieldFiringWeakly.skully = {time: 50.96, duration: 0, paused: true}
      insideRetinaReceptiveFieldOffCenterFiring.skully = {time: 51.5, duration: 3, paused: true}
      insideRetinaReceptiveFieldOffCenterDead.skully = {time: 51.63, duration: 1, paused: true}
      insideRetinaReceptiveFieldOnCenterFiring.skully = {time: 51.8, duration: 1, paused: true}
      insideThroughTheBrain.skully = {time: 65, duration: 3, paused: true}
      insideVisualCortex.skully = {time: 86, duration: 5, paused: true}

      When(buildInRange(insideEnterSkully, insideVisualCortex))
        .changed(((_ts, build) => build.skully && skully.seekTo(build.skully)))
    </script>

    <div id=ht2a>
      <type-writer id=ht2aTitle></type-writer>
      <video id=ht2aVideo src=5ht2a.m4v loop></video>
    </div>
    <div id=ht2aLSDBinding>
      <type-writer id=ht2aLSDTitle></type-writer>
      <img src=lsd-binding-lid.png>
    </div>  
    <build-note id=inside5ht2a></build-note>
    <build-note id=inside5ht2aLSDBinding></build-note>
    <script>
      When(buildInRange(inside5ht2a, inside5ht2aLSDBinding))
        .start(() => {
          ht2aTitle.text = '5-HT2 receptor subtype A'
          ht2aVideo.currentTime = 0
          ht2aVideo.playbackRate = 2
          ht2aVideo.play()
        })
      When(inside5ht2aLSDBinding)
        .start(() => ht2aLSDTitle.text = 'LSD 5-ht2a binding - EL2 "lid"')
    </script>

    <div id=adversarialSticker>
      <type-writer id=stickerTitle></type-writer>
      <video src=adversarial-sticker.m4v loop autoplay>
    </div>
    <div id=adversarialSkiiers>
      <type-writer id=skiiersTitle></type-writer>
      <img src=adversarial-skiiers.gif>  
    </div>
    <build-note id=insideAdversarialSticker></build-note>
    <build-note id=insideAdversarialSkiiers></build-note>
    <script>
      When(buildInRange(inside5ht2a, insideAdversarialSkiiers))
        .end(() => ht2aTitle.text = ht2aLSDTitle.text = stickerTitle.text = skiiersTitle.text = '')
      When(insideAdversarialSticker)
        .start(() => stickerTitle.text = 'Adversarial patch (arXiv:1712.09665v2)')
      When(insideAdversarialSkiiers)
        .start(() => skiiersTitle.text = 'Black-box adversarial example (arXiv:1712.07113v2)')
    </script>

    <build-note id=hallucinationsToSleep></build-note>
    <script>
      let hallucinationBuilds =
        [...hallucinations.getElementsByTagName('build-note')]
          .filter(x => !x.skully)
      When(hallucinationsToSleep)
        .start(() => titleWriter.text = '')
        .frame(every(0.1[sec]) ((_, i) => {
          const lastBuild = hallucinationBuilds[hallucinationBuilds.length - i - 2]
          const nextBuild = hallucinationBuilds[hallucinationBuilds.length - i - 3]
          if (!nextBuild) return
          document.body.classList.remove(lastBuild.id)
          document.body.classList.add(nextBuild.id)
        }))
        .end(() => document.body.classList.remove(hallucinationBuilds[0].id))
    </script>
  </div>
  <div id=dreams>
    <build-note id=title2             data-text='2. '></build-note>
    <build-note id=title2Dreams       data-text='2. dreams'></build-note>
    <script>
      When(buildInRange(title2, title2Dreams))
        .changed((_, current, prev) => {
          titleWriter.text = current.dataset.text
        })
    </script>

    <build-note id=title2DreamsBlur data-time=10 data-paused></build-note>
    <div id=faces>
      <video id=facesVideo src=gan-faces.mp4 class=layer is=seekable-video></video>
      <script>const discrim = createLayers({prefix: 'discrim', className: 'discrim-layer', count: 20})</script>
      <script>const gen = createLayers({prefix: 'gen', className: 'gen-layer', count: 10})</script>
    </div>
    <build-note id=dreamsPlaying data-time=10></build-note>
    <build-note id=dreamsTraining data-duration=1 data-time=51 data-playback-rate=0.5></build-note>
    <build-note id=dreamsTrainingExpand data-duration=10 data-playback-rate=0.1></build-note>
    <build-note id=dreamsTrainingDiscriminator data-duration=10 data-playback-rate=0.1></build-note>
    <build-note id=dreamsTrainingFeedback data-duration=10 data-playback-rate=0.1></build-note>
    <build-note id=dreamsInterpolation data-duration=2 data-time=77.2></build-note>
    <script>
      When(buildInRange(title2DreamsBlur, dreamsInterpolation))
        .changed((_, {dataset: {time, duration=0, paused, playbackRate=1}}) =>
          facesVideo.seekTo({time, duration, playbackRate, paused: typeof paused !== 'undefined'}))      

      When(buildInRange(dreamsTraining, dreamsTrainingFeedback))
        .frame(function() {
          this.lastTime = this.lastTime || 0
          const now = Math.floor(facesVideo.currentTime * 10)
          if (this.lastTime !== now) {
            gen_9.innerHTML = `<pre>${randomMatrix(5, 5)}</pre>`
            gen_9.style.opacity = 1
            this.lastTime = now
          }
          if (facesVideo.currentTime > 78)
            facesVideo.currentTime = 47
        })
        .end(() => gen_9.style.opacity = 0)

      When(buildInRange(dreamsTrainingExpand, dreamsTrainingFeedback))
        .withDuration(20[sec])
        .start(async function() {
          this.zRot = lerp(0, 360, _ => _ % 360)
          this.xRot = lerp(0, 70)
          this.zoom = lerp(1, 0.4)
          this.expand = lerp(0, 1)
          this.panDown = For(3[sec])
            .at(t => faces.style.setProperty('--stack-rotate-x', this.xRot(t) + 'deg'))
          this.zoomOut = For(8[sec])
            .at(t => faces.style.setProperty('--stack-zoom', this.zoom(t)))
          this.expandStack = For(6[sec])
            .at(t => faces.style.setProperty('--stack-expand', this.expand(t)))
        })
        .at(function(t) {
          faces.style.setProperty('--stack-rotate-z', this.zRot(t % 1) + 'deg')
        })        
        .end(function () {
          this.panDown.remove()
          this.zoomOut.remove()
          const zReset = lerp(this.zRot(this.t % 1), 0, _ => _ + 'deg')
          const xReset = lerp(this.xRot(this.panDown.t), 0, _ => _ + 'deg')
          const zoomReset = lerp(this.zoom(this.zoomOut.t), 1)
          For(1[sec])
            .at(t => {
              faces.style.setProperty('--stack-rotate-x', xReset(t))
              faces.style.setProperty('--stack-zoom', zoomReset(t))
              faces.style.setProperty('--stack-rotate-z', zReset(t))
            })
            .end(() => {
              faces.style.setProperty('--stack-rotate-x', 0)
              faces.style.setProperty('--stack-zoom', 1)
              faces.style.setProperty('--stack-rotate-z', 0)
            })         
        })

        When(dreamsTrainingFeedback).withDuration(3[sec])
          .start(function() {
            this.z = lerp(-80, 10)
          })
          .at(function(t) {
            if (t > 1) return
            faces.style.setProperty('--discrim-to-z', this.z(t) + 'vh')
          })
          .end(() => faces.style.setProperty('--discrim-to-z', '-80vh'))
          
    </script>
  
  </div>